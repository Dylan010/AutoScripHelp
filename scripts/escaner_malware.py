# escaner_malware.py

import os
import subprocess
from deteccion_so import obtener_info_sistema

def escanear_windows():
    print("Iniciando escaneo de Windows Defender...")
    try:
        subprocess.run(["powershell", "Start-MpScan", "-ScanType", "QuickScan"], check=True)
        print("Escaneo de Windows Defender completado.")
    except subprocess.CalledProcessError:
        print("Error al ejecutar Windows Defender.")

def escanear_linux():
    print("Para escanear en busca de malware en Linux, se recomienda instalar y usar ClamAV.")
    respuesta = input("¿Desea instalar ClamAV? (s/n): ")
    if respuesta.lower() == 's':
        try:
            subprocess.run(["sudo", "apt", "update"], check=True)
            subprocess.run(["sudo", "apt", "install", "clamav", "-y"], check=True)
            subprocess.run(["sudo", "freshclam"], check=True)
            print("ClamAV instalado y actualizado.")
            
            ruta_escaneo = input("Ingrese la ruta a escanear (por defecto /home): ") or "/home"
            print(f"Iniciando escaneo de {ruta_escaneo}...")
            subprocess.run(["sudo", "clamscan", "-r", ruta_escaneo], check=True)
            print("Escaneo completado.")
        except subprocess.CalledProcessError:
            print("Error al instalar o ejecutar ClamAV.")
    else:
        print("Instalación de ClamAV cancelada.")

def main():
    info_sistema = obtener_info_sistema()
    if info_sistema["Sistema"] == "Windows":
        escanear_windows()
    elif info_sistema["Sistema"] == "Linux":
        escanear_linux()
    else:
        print(f"Sistema operativo no soportado: {info_sistema['Sistema']}")

if __name__ == "__main__":
    main()
